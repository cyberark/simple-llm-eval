name: "Pull Request Labeler"

permissions:
  contents: read

on:
- pull_request_target

jobs:
  labeler:
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: üîÑ Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1

    - name: Set up Python
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
      with:
        python-version: "3.x"

    - name: üè∑Ô∏è File Based PR Labeling
      # See .github/labeler.yml
      uses: actions/labeler@634933edcd8ababfe52f92936142cc22ac488b1b # v6.0.1

    - name: üè∑Ô∏è Keyword PR Labeling - Propose labels
      id: propose_labels
      env:
        PR_TITLE: ${{ github.event.pull_request.title }}
        PR_BODY: ${{ github.event.pull_request.body }}
      run: |
        set -e
        LABELS=$(python3 ./ci/scripts/propose_pull_request_labels.py | jq -c .)
        echo "labels=$LABELS"
        echo "labels=$LABELS" >> $GITHUB_OUTPUT

    - name: üè∑Ô∏è Apply labels to PR
      if: ${{ steps.propose_labels.outputs.labels != '[]' }}
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # 8.0.0
      with:
        script: |
          const labels = JSON.parse(process.env.LABELS);
          if (labels.length) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels,
            });
          }
      env:
        LABELS: ${{ steps.propose_labels.outputs.labels }}
