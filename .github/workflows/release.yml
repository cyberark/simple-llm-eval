name: ğŸš€ Release

on:
  workflow_dispatch:
  # push:
  #   tags:
  #     - 'v*'  # Trigger only on version tags like v1.2.3
jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Include tag info

      - name: ğŸ·ï¸ Get latest tag
        id: get_tag
        run: echo "tag=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      - name: ğŸ”„ Fetch gh-pages branch
        run: git fetch origin gh-pages:gh-pages

      - name: ğŸ Install uv with caching
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: ğŸ“¦ Install dev packages
        run: uv sync --locked --all-extras --dev

      - name: ğŸ” Validate tag value
        run: |
          VERSION=${{ steps.get_tag.outputs.tag }}
          echo "::debug::VERSION=$VERSION"
          echo "Command: uv run ci/scripts/validate_tag.py $VERSION"
          uv run ci/scripts/validate_tag.py "$VERSION"

      - name: ğŸ“¦ Build Project Package
        run: uv build

      - name: ğŸš€ Publish to PyPI
        if: false  # Done in a side pipeline
        env:
          UV_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          uv publish

      - name: ğŸ“š Publish Docs
        run: |
          VERSION=${{ steps.get_tag.outputs.tag }}
          # Only publish docs on releases
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Publishing docs for version $VERSION"
            ci/scripts/publish_docs.sh "$VERSION"
          else
            echo "Skipping docs publish: $VERSION is not a release version (x.y.z)"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          files: |
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
