name: ğŸš€ Release

permissions:
  contents: read

on:
  workflow_dispatch:
jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # 5.0.0
        with:
          fetch-depth: 0 # Include tag info

      - name: ğŸ·ï¸ Get latest tag
        id: get_tag
        run: echo "tag=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      - name: ğŸ”„ Fetch gh-pages branch
        run: git fetch origin gh-pages:gh-pages

      - name: ğŸ Install uv with caching
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # 7.1.4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: ğŸ“¦ Install dev packages
        run: uv sync --locked --all-extras --dev

      - name: ğŸ” Validate tag value
        run: |
          VERSION=${{ steps.get_tag.outputs.tag }}
          echo "::debug::VERSION=$VERSION"
          echo "Command: uv run ci/scripts/validate_tag.py $VERSION"
          uv run ci/scripts/validate_tag.py "$VERSION"

      - name: ğŸ“¦ Build Project Package
        run: uv build

      - name: ğŸš€ Publish to PyPI
        if: false  # Done in a side pipeline
        env:
          UV_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          uv publish

      - name: ğŸ“š Publish Docs
        run: |
          VERSION=${{ steps.get_tag.outputs.tag }}
          # Only publish docs on releases, e.g., 1.2.3 or v1.2.3
          if [[ "$VERSION" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Publishing docs for version $VERSION"
            ci/scripts/publish_docs.sh "$VERSION"
          else
            echo "Skipping docs publish: $VERSION is not a release version ([v]x.y.z)"
          fi

      - name: ğŸ”‘ Import GPG Key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          echo "${{ secrets.GPG_OWNERTRUST }}" | gpg --import-ownertrust || true

      - name: ğŸ” Sign the wheel(s)
        run: |
          for f in dist/*.{whl,tar.gz}; do
            gpg --batch --yes --armor --detach-sign "$f"
          done

      - name: List dist content
        run: ls dist

      - name: ğŸ“ Create GitHub Release
        run: |
          TAG=${{ steps.get_tag.outputs.tag }}
          gh release create "$TAG" \
            --title "$TAG" \
            --generate-notes \
            --target "${GITHUB_SHA}" \
            --verify-tag \
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
